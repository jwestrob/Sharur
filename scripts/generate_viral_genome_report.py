#!/usr/bin/env python3
"""
Generate comprehensive PDF report for GJALLARVIRUS genome analysis.

Uses the Bennu infrastructure with proper styling:
- Table of contents with page numbers
- Styled headers and evidence boxes
- Markdown rendering with bold support
- Dynamic stats from database
- Integrated figures with proper legends
"""

import json
import os
import re
import sys
from pathlib import Path
from datetime import datetime
from collections import defaultdict

sys.path.insert(0, str(Path(__file__).parent.parent))

from fpdf import FPDF
import duckdb

# Configuration
DB_PATH = "data/heimdall_megavirus_production/bennu.duckdb"
DATA_DIR = Path("data/heimdall_megavirus_production")
SURVEY_DIR = DATA_DIR / "survey"
EXPLORATION_DIR = DATA_DIR / "exploration"
STRUCTURES_DIR = DATA_DIR / "structures"
FINDINGS_PATH = EXPLORATION_DIR / "findings.jsonl"
SURVEY_FIGURES = SURVEY_DIR / "figures"
EXPLORATION_FIGURES = EXPLORATION_DIR / "figures"
STRUCTURE_FINDINGS = DATA_DIR / "STRUCTURE_PREDICTION_FINDINGS.md"
FOLDSEEK_RESULTS = DATA_DIR / "foldseek_results.tsv"
OUTPUT_PDF = DATA_DIR / "COMPREHENSIVE_REPORT.pdf"  # Standard filename - DO NOT CHANGE


def clean_text(text):
    """Clean text for PDF rendering - handle unicode."""
    if not text:
        return ""
    replacements = {
        '\u2192': '->', '\u2190': '<-', '\u2194': '<->',
        '\u2265': '>=', '\u2264': '<=', '\u2260': '!=',
        '\u03b1': 'alpha', '\u03b2': 'beta', '\u03b3': 'gamma',
        '\u03b4': 'delta', '\u03b5': 'epsilon', '\u03bc': 'mu',
        '\u2022': '*', '\u2013': '-', '\u2014': '--',
        '\u201c': '"', '\u201d': '"', '\u2018': "'", '\u2019': "'",
        '\u00b0': ' deg', '\u00b5': 'u', '\u00d7': 'x',
        '\u2248': '~', '\u221e': 'inf', '\u00b1': '+/-',
    }
    for old, new in replacements.items():
        text = text.replace(old, new)
    text = text.encode('latin-1', 'replace').decode('latin-1')
    return text


class MegavirusReport(FPDF):
    """PDF report with professional styling."""

    def __init__(self):
        super().__init__()
        self.set_auto_page_break(auto=True, margin=20)
        self.set_margins(left=20, top=15, right=20)
        self.toc_entries = []
        self.in_toc = False
        self.figure_counter = 0

    def header(self):
        if self.page_no() > 1:
            self.set_draw_color(80, 40, 120)  # Purple for virus
            self.set_line_width(0.3)
            self.line(20, 12, self.w - 20, 12)
            self.set_font('Helvetica', 'I', 8)
            self.set_text_color(100, 100, 100)
            self.cell(0, 8, 'GJALLARVIRUS Genome Analysis', 0, 0, 'L')
            self.cell(0, 8, f'Page {self.page_no()}', 0, 0, 'R')
            self.ln(12)
            self.set_text_color(0, 0, 0)

    def footer(self):
        if self.in_toc:
            return
        self.set_y(-15)
        self.set_draw_color(80, 40, 120)
        self.set_line_width(0.2)
        self.line(20, self.h - 18, self.w - 20, self.h - 18)
        self.set_font('Helvetica', 'I', 7)
        self.set_text_color(120, 120, 120)
        self.cell(0, 10, 'Generated by Bennu Metagenomic Analysis System', 0, 0, 'C')

    def chapter_title(self, num, title, add_to_toc=True):
        if add_to_toc:
            self.toc_entries.append((num, title, self.page_no()))
        self.set_font('Helvetica', 'B', 16)
        self.set_fill_color(80, 40, 120)  # Purple
        self.set_text_color(255, 255, 255)
        self.set_x(self.l_margin + 1)
        self.cell(self.w - self.l_margin - self.r_margin - 1, 12, f'  {num}. {title}', 0, 1, 'L', True)
        self.set_text_color(0, 0, 0)
        self.ln(6)

    def section_title(self, title):
        self.set_font('Helvetica', 'B', 12)
        self.set_text_color(80, 40, 120)
        title = clean_text(title)[:100]
        self.multi_cell(self.w - self.l_margin - self.r_margin, 8, title, align='L')
        self.set_text_color(0, 0, 0)
        self.ln(2)

    def subsection_title(self, title):
        self.set_font('Helvetica', 'B', 10)
        self.set_text_color(100, 60, 140)
        title = clean_text(title)[:120]
        self.multi_cell(self.w - self.l_margin - self.r_margin, 7, title, align='L')
        self.set_text_color(0, 0, 0)
        self.ln(1)

    def body_text(self, text):
        """Render body text with markdown support for **bold** formatting."""
        if not text:
            return

        # Split text into paragraphs
        paragraphs = text.split('\n\n')

        for para in paragraphs:
            if not para.strip():
                continue

            para = clean_text(para)

            # Parse markdown bold (**text**)
            parts = []
            current_pos = 0

            import re
            # Find all **bold** patterns
            for match in re.finditer(r'\*\*(.+?)\*\*', para):
                # Add text before bold
                if match.start() > current_pos:
                    parts.append(('normal', para[current_pos:match.start()]))
                # Add bold text
                parts.append(('bold', match.group(1)))
                current_pos = match.end()

            # Add remaining text
            if current_pos < len(para):
                parts.append(('normal', para[current_pos:]))

            # Render each part
            if not parts:  # No markdown found
                self.set_font('Helvetica', '', 10)
                self.multi_cell(self.w - self.l_margin - self.r_margin, 5, para, align='L')
            else:
                # Render with mixed formatting
                x_start = self.get_x()
                y_start = self.get_y()
                max_width = self.w - self.l_margin - self.r_margin

                for i, (style, content) in enumerate(parts):
                    if style == 'bold':
                        self.set_font('Helvetica', 'B', 10)
                    else:
                        self.set_font('Helvetica', '', 10)

                    # Use write instead of multi_cell for inline formatting
                    self.write(5, content)

                self.ln()

            self.ln(2)

    def add_bullet(self, text):
        self.set_font('Helvetica', '', 10)
        text = clean_text(text)
        self.set_x(self.l_margin + 5)
        self.cell(5, 5, chr(149), 0, 0)
        self.multi_cell(self.w - self.get_x() - self.r_margin, 5, text, align='L')

    def add_evidence_box(self, text):
        self.set_font('Helvetica', 'I', 9)
        self.set_fill_color(245, 240, 250)  # Light purple
        self.set_text_color(80, 40, 120)
        text = clean_text(text)
        self.set_x(self.l_margin)
        self.multi_cell(self.w - self.l_margin - self.r_margin, 5, f"  {text}", 0, 'L', True)
        self.set_text_color(0, 0, 0)
        self.ln(2)

    def add_table(self, headers, data, col_widths=None):
        if not data:
            return
        n_cols = len(headers)
        available = self.w - self.l_margin - self.r_margin - 4
        if col_widths is None:
            col_widths = [available / n_cols] * n_cols

        self.maybe_add_page(40)

        # Header row
        self.set_font('Helvetica', 'B', 9)
        self.set_fill_color(80, 40, 120)
        self.set_text_color(255, 255, 255)
        self.set_x(self.l_margin + 2)
        for i, h in enumerate(headers):
            self.cell(col_widths[i], 6, clean_text(str(h))[:25], 1, 0, 'C', True)
        self.ln()

        # Data rows
        self.set_font('Helvetica', '', 8)
        self.set_text_color(40, 40, 40)
        for row_idx, row in enumerate(data):
            if row_idx % 2 == 0:
                self.set_fill_color(250, 245, 255)
            else:
                self.set_fill_color(255, 255, 255)
            self.set_x(self.l_margin + 2)
            for i, cell in enumerate(row):
                self.cell(col_widths[i], 5, clean_text(str(cell))[:35], 1, 0, 'L', True)
            self.ln()
        self.set_text_color(0, 0, 0)
        self.ln(3)

    def add_separator(self):
        self.ln(2)
        self.set_draw_color(200, 180, 220)
        self.set_line_width(0.2)
        y = self.get_y()
        self.line(self.l_margin + 20, y, self.w - self.r_margin - 20, y)
        self.ln(4)

    def add_image_with_legend(self, path, legend_title, legend_text, width=170):
        """Add image with proper figure legend."""
        if not os.path.exists(path):
            return False
        try:
            self.figure_counter += 1
            self.maybe_add_page(85)
            self.image(path, x=20, w=width)
            self.ln(3)
            # Figure legend
            self.set_font('Helvetica', 'B', 9)
            self.set_text_color(80, 40, 120)
            fig_title = f"Figure {self.figure_counter}: {legend_title}"
            self.cell(0, 5, clean_text(fig_title), 0, 1, 'L')
            self.set_font('Helvetica', '', 8)
            self.set_text_color(60, 60, 60)
            self.multi_cell(self.w - self.l_margin - self.r_margin, 4, clean_text(legend_text), align='L')
            self.set_text_color(0, 0, 0)
            self.ln(5)
            return True
        except Exception as e:
            self.body_text(f"[Could not load image: {e}]")
            return False

    def add_toc_entry(self, num, title, page):
        self.set_font('Helvetica', '', 11)
        self.set_text_color(40, 40, 40)
        text = f"{num}. {title}"
        text_width = self.get_string_width(text)
        page_str = str(page)
        page_width = self.get_string_width(page_str)
        available = self.w - self.l_margin - self.r_margin - text_width - page_width - 5
        dot_width = self.get_string_width(' . ')
        num_dots = int(available / dot_width)
        dots = ' .' * num_dots

        self.cell(text_width + 2, 7, text, 0, 0, 'L')
        self.set_text_color(180, 180, 180)
        self.cell(available, 7, dots, 0, 0, 'L')
        self.set_text_color(80, 40, 120)
        self.set_font('Helvetica', 'B', 11)
        self.cell(page_width + 3, 7, page_str, 0, 1, 'R')
        self.set_text_color(0, 0, 0)

    def maybe_add_page(self, min_space=60):
        if self.get_y() > (self.h - self.b_margin - min_space):
            self.add_page()


def load_findings():
    """Load exploration findings."""
    findings = []
    if FINDINGS_PATH.exists():
        with open(FINDINGS_PATH) as f:
            for line in f:
                if line.strip():
                    findings.append(json.loads(line))
    return findings


def get_db_stats():
    """Get statistics from database."""
    db = duckdb.connect(str(DB_PATH), read_only=True)

    stats = {}
    stats['total_proteins'] = db.execute("SELECT COUNT(*) FROM proteins").fetchone()[0]
    stats['annotated'] = db.execute(
        "SELECT COUNT(DISTINCT protein_id) FROM annotations"
    ).fetchone()[0]
    stats['unannotated'] = stats['total_proteins'] - stats['annotated']
    stats['avg_length'] = db.execute("SELECT AVG(sequence_length) FROM proteins").fetchone()[0]
    stats['max_length'] = db.execute("SELECT MAX(sequence_length) FROM proteins").fetchone()[0]
    stats['min_length'] = db.execute("SELECT MIN(sequence_length) FROM proteins").fetchone()[0]

    # Annotation sources
    stats['pfam_count'] = db.execute("SELECT COUNT(*) FROM annotations WHERE source = 'pfam'").fetchone()[0]
    stats['kegg_count'] = db.execute("SELECT COUNT(*) FROM annotations WHERE source = 'kegg'").fetchone()[0]
    stats['vog_count'] = db.execute("SELECT COUNT(*) FROM annotations WHERE source = 'vogdb'").fetchone()[0]

    # Size distribution
    sizes = db.execute("""
        SELECT
            SUM(CASE WHEN sequence_length < 200 THEN 1 ELSE 0 END) as small,
            SUM(CASE WHEN sequence_length >= 200 AND sequence_length < 500 THEN 1 ELSE 0 END) as medium,
            SUM(CASE WHEN sequence_length >= 500 AND sequence_length < 1000 THEN 1 ELSE 0 END) as large,
            SUM(CASE WHEN sequence_length >= 1000 THEN 1 ELSE 0 END) as giant
        FROM proteins
    """).fetchone()
    stats['small'] = sizes[0]
    stats['medium'] = sizes[1]
    stats['large'] = sizes[2]
    stats['giant'] = sizes[3]

    # Giant unannotated
    stats['giant_unannotated'] = db.execute("""
        SELECT COUNT(*) FROM proteins p
        WHERE p.sequence_length >= 1000
        AND NOT EXISTS (SELECT 1 FROM annotations a WHERE a.protein_id = p.protein_id)
    """).fetchone()[0]

    # Top PFAM domains
    stats['top_pfam'] = db.execute("""
        SELECT name, COUNT(*) as cnt
        FROM annotations WHERE source = 'pfam'
        GROUP BY name
        ORDER BY cnt DESC
        LIMIT 15
    """).fetchall()

    db.close()
    return stats


def load_foldseek_results():
    """Load Foldseek structural homology results."""
    results = []
    if FOLDSEEK_RESULTS.exists():
        with open(FOLDSEEK_RESULTS) as f:
            header = next(f).strip().split('\t')
            # Determine column indices
            col_idx = {h: i for i, h in enumerate(header)}
            for line in f:
                parts = line.strip().split('\t')
                if len(parts) >= 5:
                    try:
                        results.append({
                            'gene': parts[col_idx.get('gene', 0)],
                            'protein_id': parts[col_idx.get('protein_id', 1)],
                            'database': parts[col_idx.get('database', 2)],
                            'target': parts[col_idx.get('target', 3)],
                            'evalue': float(parts[col_idx.get('evalue', 4)]) if parts[col_idx.get('evalue', 4)] else 1.0,
                            'identity': float(parts[col_idx.get('seq_identity', 6)]) if col_idx.get('seq_identity') and parts[col_idx.get('seq_identity', 6)] else 0,
                            'description': parts[col_idx.get('description', 7)] if col_idx.get('description') else ''
                        })
                    except (ValueError, IndexError):
                        continue
    return results


def count_structures():
    """Count predicted structures."""
    if STRUCTURES_DIR.exists():
        return len(list(STRUCTURES_DIR.glob("*.pdb")))
    return 0


def generate_report():
    print("=" * 60)
    print("HEIMDALL MEGAVIRUS COMPREHENSIVE REPORT GENERATOR")
    print("=" * 60)

    # Load data
    print("\nLoading data...")
    findings = load_findings()
    stats = get_db_stats()
    foldseek = load_foldseek_results()
    n_structures = count_structures()

    print(f"  Findings: {len(findings)}")
    print(f"  Proteins: {stats['total_proteins']}")
    print(f"  Structures: {n_structures}")
    print(f"  Foldseek hits: {len(foldseek)}")

    pdf = MegavirusReport()

    # ==================== TITLE PAGE ====================
    print("\nCreating title page...")
    pdf.add_page()

    # Decorative bars - purple theme
    pdf.set_fill_color(80, 40, 120)
    pdf.rect(0, 0, pdf.w, 8, 'F')
    pdf.set_fill_color(120, 70, 160)
    pdf.rect(0, 8, pdf.w, 3, 'F')

    pdf.ln(50)
    pdf.set_font('Helvetica', 'B', 32)
    pdf.set_text_color(80, 40, 120)
    pdf.cell(0, 15, 'GJALLARVIRUS', 0, 1, 'C')
    pdf.set_font('Helvetica', '', 18)
    pdf.set_text_color(120, 80, 160)
    pdf.cell(0, 10, 'NCLDV Giant Virus Analysis', 0, 1, 'C')
    pdf.ln(5)
    pdf.set_font('Helvetica', 'I', 14)
    pdf.cell(0, 10, 'Structure Prediction & Functional Annotation', 0, 1, 'C')

    # Decorative line
    pdf.ln(10)
    pdf.set_draw_color(80, 40, 120)
    pdf.set_line_width(0.8)
    pdf.line(50, pdf.get_y(), pdf.w - 50, pdf.get_y())
    pdf.ln(15)

    # Key stats
    pdf.set_text_color(60, 60, 60)
    pdf.set_font('Helvetica', '', 12)
    annot_pct = stats['annotated'] / stats['total_proteins'] * 100
    pdf.cell(0, 8, f"{stats['total_proteins']:,} proteins  |  {annot_pct:.0f}% annotated  |  {n_structures} structures predicted", 0, 1, 'C')
    pdf.cell(0, 8, f"{len(findings)} genomic loci documented  |  {len(foldseek)} structural homologs identified", 0, 1, 'C')
    pdf.ln(8)
    pdf.set_font('Helvetica', 'I', 10)
    pdf.set_text_color(120, 120, 120)
    pdf.cell(0, 8, f'Generated: {datetime.now().strftime("%B %d, %Y")}', 0, 1, 'C')

    # Bottom decoration
    pdf.set_fill_color(80, 40, 120)
    pdf.rect(0, pdf.h - 8, pdf.w, 8, 'F')

    # ==================== TABLE OF CONTENTS ====================
    toc_page = pdf.page_no() + 1
    pdf.add_page()
    pdf.in_toc = True
    pdf.set_font('Helvetica', 'B', 20)
    pdf.set_text_color(80, 40, 120)
    pdf.cell(0, 12, 'Table of Contents', 0, 1, 'L')
    pdf.set_draw_color(80, 40, 120)
    pdf.set_line_width(0.5)
    pdf.line(pdf.l_margin, pdf.get_y(), pdf.l_margin + 60, pdf.get_y())
    pdf.ln(12)
    toc_y_start = pdf.get_y()
    pdf.in_toc = False

    # ==================== EXECUTIVE SUMMARY ====================
    print("Creating executive summary...")
    pdf.add_page()
    pdf.chapter_title(1, 'Executive Summary')

    summary = f"""This report presents a comprehensive analysis of the GJALLARVIRUS genome, a nucleocytoplasmic large DNA virus (NCLDV). The analysis integrates sequence-based annotation (PFAM, KEGG, VOGdb), systematic genome exploration, and structure-based functional inference using ESM3 and Foldseek.

The genome encodes {stats['total_proteins']:,} proteins with annotations from three databases: {stats['pfam_count']} PFAM domains, {stats['kegg_count']} KEGG orthologs, and {stats['vog_count']} VOGdb hits. Of these, {stats['unannotated']:,} proteins ({100-annot_pct:.1f}%) remain functionally uncharacterized, including {stats['giant_unannotated']} giant proteins exceeding 1,000 amino acids.

Structure prediction using ESM3 was performed on {n_structures} unannotated proteins. Foldseek structural homology search against AlphaFold DB and PDB identified putative functions for several previously unknown proteins, with the most significant discovery being a potential RNA-dependent RNA polymerase (RdRp)."""

    pdf.body_text(summary)

    pdf.section_title("Major Findings")
    major_findings = [
        "RdRp Discovery (Gene 584): Structural homology to RNA-dependent RNA polymerases - unexpected in a DNA virus, suggesting HGT or novel RNA-processing function",
        "Orphan Intein (Gene 541): Free-standing intein domain with structural match to archaeal TFIIB mini-intein, representing a mobile genetic element",
        "Type I CRISPR-Cas: Complete system with Cas6 and Cas3 - the virus encodes its own adaptive immunity",
        "TnpB Transposases: 5 Cas12f1-like proteins are TnpB transposases (IS200/IS605 family), the evolutionary precursors of Cas12 effectors",
        "Eukaryotic Transcription: Complete TBP/TFIIB machinery for host-independent transcription",
        "19 Methyltransferases: Extensive DNA modification system likely for host restriction evasion"
    ]
    for finding in major_findings:
        pdf.add_bullet(finding)

    # ==================== GENOME STATISTICS ====================
    print("Creating genome statistics section...")
    pdf.add_page()
    pdf.chapter_title(2, 'Genome Statistics')

    pdf.section_title("Annotation Summary")
    pdf.add_table(
        ["Metric", "Value"],
        [
            ["Total proteins", f"{stats['total_proteins']:,}"],
            ["Annotated", f"{stats['annotated']:,} ({annot_pct:.1f}%)"],
            ["Unannotated", f"{stats['unannotated']:,} ({100-annot_pct:.1f}%)"],
            ["PFAM domains", f"{stats['pfam_count']:,}"],
            ["KEGG orthologs", f"{stats['kegg_count']:,}"],
            ["VOGdb hits", f"{stats['vog_count']:,}"],
        ],
        col_widths=[80, 80]
    )

    pdf.section_title("Protein Size Distribution")
    pdf.add_table(
        ["Size Class", "Count", "Percentage"],
        [
            ["Small (<200 aa)", f"{stats['small']:,}", f"{stats['small']/stats['total_proteins']*100:.1f}%"],
            ["Medium (200-499 aa)", f"{stats['medium']:,}", f"{stats['medium']/stats['total_proteins']*100:.1f}%"],
            ["Large (500-999 aa)", f"{stats['large']:,}", f"{stats['large']/stats['total_proteins']*100:.1f}%"],
            ["Giant (>=1000 aa)", f"{stats['giant']:,}", f"{stats['giant']/stats['total_proteins']*100:.1f}%"],
        ],
        col_widths=[60, 50, 50]
    )

    # Add genome map figure if exists
    genome_map = SURVEY_FIGURES / "genome_map.png"
    if genome_map.exists():
        pdf.add_image_with_legend(
            str(genome_map),
            "Genome Map Overview",
            "Linear representation of the GJALLARVIRUS genome showing gene density and distribution. Each tick represents a protein-coding gene. The genome encodes 588 proteins across approximately 1.2 Mb."
        )

    # Add size distribution figure
    size_dist = SURVEY_FIGURES / "size_distribution.png"
    if size_dist.exists():
        pdf.add_image_with_legend(
            str(size_dist),
            "Protein Size Distribution",
            "Histogram showing the distribution of protein lengths across the genome. The majority of proteins fall in the small-to-medium range (100-400 aa), with notable outliers including the 1,898 aa ribonucleotide reductase and several giant unannotated proteins exceeding 1,000 aa."
        )

    # ==================== CRISPR & DEFENSE ====================
    print("Creating CRISPR/defense section...")
    pdf.add_page()
    pdf.chapter_title(3, 'CRISPR-Cas & Defense Systems')

    pdf.section_title("The CRISPR/TnpB Mystery - Resolved")
    crispr_intro = """Initial annotation identified 10 CRISPR-associated domains, but detailed analysis revealed that 5 of these (Cas12f1-like proteins) are actually TnpB transposases - the evolutionary precursors of Cas12 effectors. The remaining 5 represent a genuine Type I CRISPR-Cas system."""
    pdf.body_text(crispr_intro)

    pdf.subsection_title("True CRISPR-Cas Components")
    pdf.add_table(
        ["Gene", "Length", "Annotation", "Function"],
        [
            ["164", "308 aa", "Cas6 (K19091)", "crRNA processing"],
            ["416", "779 aa", "Cas3 (K07012)", "Type I effector nuclease"],
            ["415", "279 aa", "Cas6 (K19091)", "crRNA processing"],
            ["256", "109 aa", "Cas_csx3", "CRISPR-associated"],
            ["161-162", "various", "K19120/K19121", "Cas accessory"],
        ],
        col_widths=[25, 35, 55, 55]
    )

    pdf.subsection_title("TnpB Transposases (Not True CRISPR)")
    pdf.body_text("The 5 Cas12f1-like proteins are actually TnpB transposases from the IS200/IS605 family (KEGG K07496). TnpB proteins are the most abundant RNA-guided nucleases in bacteria and archaea, predating the evolution of CRISPR-Cas systems.")
    pdf.add_table(
        ["Gene", "Length", "Evidence"],
        [
            ["81", "453 aa", "K07496 + no CRISPR array"],
            ["172", "300 aa", "K07496 + TFIIB domain"],
            ["181", "398 aa", "K07496"],
            ["231", "358 aa", "K07496"],
            ["558", "455 aa", "K07496 + OrfB_IS605 nearby"],
        ],
        col_widths=[30, 40, 100]
    )

    # Add CRISPR figure
    cas6_fig = EXPLORATION_FIGURES / "Cas6_CRISPR_gene164_neighborhood.png"
    if cas6_fig.exists():
        pdf.add_image_with_legend(
            str(cas6_fig),
            "Type I CRISPR-Cas Locus",
            "Gene neighborhood diagram showing the genuine CRISPR-Cas locus centered on Cas6 (gene 164). Genes are colored by functional category: red for defense/CRISPR, blue for metabolism, green for information processing. The presence of Cas6 (crRNA processing) combined with Cas3 (gene 416, Type I signature) confirms a functional Type I CRISPR-Cas system."
        )

    # TnpB figure
    tnpb_fig = EXPLORATION_FIGURES / "Cas12f1_TnpB_gene81_neighborhood.png"
    if tnpb_fig.exists():
        pdf.add_image_with_legend(
            str(tnpb_fig),
            "TnpB Transposase Locus",
            "Gene neighborhood showing Cas12f1-like TnpB (gene 81). The KEGG annotation K07496 (putative transposase) and absence of nearby CRISPR arrays suggest this may be a transposase rather than a Cas12f effector, though definitive classification requires experimental validation or deeper phylogenetic analysis."
        )

    # ==================== EUKARYOTIC-LIKE FEATURES ====================
    print("Creating eukaryotic features section...")
    pdf.add_page()
    pdf.chapter_title(4, 'Eukaryotic-Like Features')

    pdf.section_title("Transcription Apparatus")
    pdf.body_text("The virus encodes a complete eukaryotic-style transcription system, characteristic of NCLDVs that don't rely on host transcription machinery.")
    pdf.add_table(
        ["Gene", "Length", "Protein", "Function"],
        [
            ["66", "393 aa", "TBP", "TATA-binding protein"],
            ["191", "197 aa", "TBP", "TATA-binding protein"],
            ["12", "310 aa", "TFIIB", "Transcription factor IIB"],
            ["167", "567 aa", "TFIIB", "Transcription factor IIB"],
        ],
        col_widths=[25, 35, 50, 60]
    )

    tbp_fig = EXPLORATION_FIGURES / "TBP_transcription_gene66_neighborhood.png"
    if tbp_fig.exists():
        pdf.add_image_with_legend(
            str(tbp_fig),
            "Viral Transcription Factor Locus",
            "Gene neighborhood showing TBP (TATA-binding protein, gene 66). TBP recognizes TATA boxes in promoter regions, initiating transcription. The viral TBP allows the megavirus to control transcription independently of host factors, enabling complete reprogramming of the cellular transcriptional landscape."
        )

    pdf.section_title("Ubiquitin System")
    pdf.body_text("Giant viruses often encode ubiquitin-like systems to target host proteins for degradation and evade immune responses.")
    pdf.add_table(
        ["Gene", "Length", "Protein", "Function"],
        [
            ["42", "83 aa", "Ubiquitin", "Protein degradation tag"],
            ["37", "253 aa", "ThiF", "E1-like activating enzyme"],
        ],
        col_widths=[30, 40, 50, 50]
    )

    ub_fig = EXPLORATION_FIGURES / "Ubiquitin_gene42_neighborhood.png"
    if ub_fig.exists():
        pdf.add_image_with_legend(
            str(ub_fig),
            "Viral Ubiquitin Locus",
            "Gene neighborhood showing viral ubiquitin (gene 42, 83 aa - typical size). Ubiquitin is flanked by the ThiF domain protein (gene 37), an E1-like activating enzyme. This system likely hijacks host protein degradation pathways to favor viral replication."
        )

    pdf.section_title("Viral Histone")
    pdf.body_text("Gene 182 encodes a histone protein (73 aa), located within a defense gene cluster containing TnpB proteins and methyltransferases.")

    histone_fig = EXPLORATION_FIGURES / "Histone_gene182_neighborhood.png"
    if histone_fig.exists():
        pdf.add_image_with_legend(
            str(histone_fig),
            "Viral Histone in Defense Island",
            "Gene neighborhood showing viral histone (gene 182) surrounded by defense-related genes including TnpB transposases (genes 172, 181), DNA methyltransferase (gene 174), and HNH nuclease (gene 178). The co-localization suggests coordinated chromatin remodeling during infection."
        )

    # ==================== STRUCTURE PREDICTION ====================
    print("Creating structure prediction section...")
    pdf.add_page()
    pdf.chapter_title(5, 'Structure-Based Annotation')

    struct_intro = f"""To characterize unannotated proteins, structure prediction was performed using ESM3 on {n_structures} candidates. Predicted structures were searched against AlphaFold DB and PDB using Foldseek to identify remote structural homologs invisible to sequence-based methods."""
    pdf.body_text(struct_intro)

    pdf.section_title("Key Structural Discovery: RNA-dependent RNA Polymerase")
    rdrp_text = """Gene 584 (620 aa) showed strong structural similarity to RNA-dependent RNA polymerases (RdRp) from viral metagenomes:

- Best hit: RdRp (AF-A0A6C0LPY5) with E-value 8.6e-06, 14.3% sequence identity
- Multiple independent RdRp hits support the structural classification

This finding is highly significant because:
1. RdRp is the signature enzyme of RNA viruses, not typically found in DNA viruses
2. Giant DNA viruses like megaviruses encode DNA polymerases, not RdRp
3. The presence suggests either horizontal gene transfer from an RNA virus or a novel RNA-processing function in the viral life cycle"""
    pdf.body_text(rdrp_text)

    pdf.section_title("Structure Prediction Results")
    pdf.add_table(
        ["Gene", "Length", "pLDDT", "pTM", "Predicted Function", "Confidence"],
        [
            ["584", "620 aa", "0.48", "0.47", "RdRp", "High"],
            ["541", "641 aa", "0.62", "0.45", "Orphan Intein", "High"],
            ["583", "658 aa", "0.46", "0.49", "Glutamine Synthetase", "High"],
            ["585", "529 aa", "0.58", "0.34", "Transglutaminase", "Medium"],
            ["525", "927 aa", "0.51", "0.29", "S8 Serine Peptidase", "Medium"],
            ["524", "1,552 aa", "0.59", "N/A", "HYR/Ig-like domain", "Medium"],
            ["119", "1,149 aa", "0.58", "N/A", "Collagen-binding", "Low"],
            ["24", "1,275 aa", "0.46", "N/A", "Unknown (TM?)", "Low"],
        ],
        col_widths=[25, 35, 28, 28, 45, 30]
    )

    pdf.section_title("Orphan Intein (Gene 541)")
    intein_text = """Gene 541 encodes a free-standing intein - an intein domain found outside its typical host protein context. This is unusual because inteins are normally embedded within essential genes.

Foldseek identified structural similarity to archaeal inteins, including TFIIB mini-intein from M. vulcanius (TM-score match). The standalone nature suggests:
- A captured intein that has lost mobility
- A homing intein that can insert into host genes
- A mobile genetic element within the viral genome"""
    pdf.body_text(intein_text)

    # ==================== GENOME EXPLORATION FINDINGS ====================
    print("Creating exploration findings section...")
    pdf.add_page()
    pdf.chapter_title(6, 'Systematic Genome Analysis')

    pdf.body_text(f"Systematic exploration identified {len(findings)} notable genomic loci. Key findings are summarized below.")

    # Group findings by category
    categories = {
        'CRISPR/TnpB': [],
        'Novel proteins': [],
        'Protein splicing': [],
        'DNA modification': [],
        'Transcription': [],
        'Host interaction': [],
        'Structural': [],
        'Other': []
    }

    for f in findings:
        cat = f.get('category', 'Other')
        if cat in categories:
            categories[cat].append(f)
        else:
            categories['Other'].append(f)

    for cat_name, cat_findings in categories.items():
        if not cat_findings:
            continue
        pdf.maybe_add_page(40)
        pdf.section_title(f"{cat_name} ({len(cat_findings)} loci)")

        for finding in cat_findings[:4]:
            pdf.maybe_add_page(35)
            pdf.subsection_title(finding.get('title', 'Untitled'))
            summary = finding.get('summary', '')
            # No truncation - let multi_cell handle wrapping
            pdf.body_text(summary)
            pdf.add_separator()

    # ==================== GENOMIC NEIGHBORHOOD FIGURES ====================
    print("Adding neighborhood figures...")
    pdf.add_page()
    pdf.chapter_title(7, 'Genomic Neighborhood Diagrams')

    pdf.body_text("Gene neighborhood diagrams showing key genomic loci. Arrows indicate gene direction and are colored by functional category.")

    # Figure definitions with proper legends
    figure_legends = {
        'Cas3_Type_I_gene416_neighborhood.png': (
            "Type I CRISPR-Cas Effector",
            "Gene neighborhood centered on Cas3 (gene 416, 779 aa), the signature nuclease-helicase of Type I CRISPR-Cas systems. Cas3 unwinds and degrades target DNA complementary to the crRNA. Adjacent genes include hypothetical proteins that may represent uncharacterized CRISPR-associated factors."
        ),
        'Giant_unknown_gene24_neighborhood.png': (
            "Giant Unannotated Protein (Gene 24)",
            "Gene neighborhood showing the 1,275 aa unannotated protein (gene 24). This region contains multiple unannotated genes, with the nearest annotated neighbor being a helicase (gene 28, K03726). The lack of any database hits suggests this may represent a virus-specific innovation."
        ),
        'Giant_unknown_gene119_neighborhood.png': (
            "Giant Unannotated Protein (Gene 119)",
            "Gene neighborhood showing the 1,149 aa unannotated protein (gene 119). Located in a region with VOG46791 cluster proteins and amidohydrolase, this protein may be involved in viral-specific metabolic functions."
        ),
        'Giant_unknown_gene524_neighborhood.png': (
            "Largest Unannotated Protein (Gene 524)",
            "Gene neighborhood showing the largest unannotated protein in the genome (gene 524, 1,552 aa). Adjacent gene 525 (927 aa) is also unannotated, together comprising 2,479 aa of unknown sequence. This may represent a split gene or novel protein complex."
        ),
        'C_terminal_dark_region_neighborhood.png': (
            "C-terminal Dark Region",
            "Gene neighborhood at the genome terminus showing 6 consecutive unannotated proteins (genes 583-588) totaling 2,554 aa. This 'dark region' follows the giant beta-helix protein (gene 581) and topoisomerase (gene 582). Position suggests possible structural or packaging functions."
        ),
        'Pre_CRISPR_unknowns_neighborhood.png': (
            "Unknown Proteins Upstream of CRISPR",
            "Gene neighborhood showing large unannotated proteins (genes 158-159, totaling 1,784 aa) immediately upstream of the CRISPR Cas6 locus. These may represent uncharacterized CRISPR-associated proteins or defense island components."
        ),
        'dna_polymerase_neighborhood.png': (
            "DNA Replication Locus",
            "Gene neighborhood showing viral DNA replication machinery. The DNA polymerase is surrounded by helicases and accessory factors essential for genome replication. The clustering of replication genes facilitates coordinated expression during the viral replication cycle."
        ),
        'rnr_intein_neighborhood.png': (
            "Ribonucleotide Reductase with Inteins",
            "Gene neighborhood showing the ribonucleotide reductase (RNR, gene 378, 1,898 aa) - the largest annotated protein in the genome. RNR contains 2 intein domains plus LAGLIDADG homing endonuclease, suggesting conditional regulation through protein splicing."
        ),
    }

    # Add figures from exploration directory
    for fig_name, (title, legend) in figure_legends.items():
        fig_path = EXPLORATION_FIGURES / fig_name
        if not fig_path.exists():
            fig_path = SURVEY_FIGURES / fig_name
        if fig_path.exists():
            pdf.add_image_with_legend(str(fig_path), title, legend)

    # ==================== CONCLUSIONS ====================
    print("Creating conclusions...")
    pdf.add_page()
    pdf.chapter_title(8, 'Conclusions')

    conclusions = f"""This comprehensive analysis of the GJALLARVIRUS genome reveals a sophisticated giant virus with unusual features:

**CRISPR-Cas Complexity**: The virus encodes its own Type I CRISPR-Cas system (Cas6 + Cas3), possibly for defense against satellite viruses or to combat host CRISPR. Five additional Cas12f1-like proteins were resolved as TnpB transposases rather than true CRISPR effectors.

**RdRp Discovery**: Structure-based annotation identified Gene 584 as a putative RNA-dependent RNA polymerase - unusual in DNA viruses. This may indicate horizontal gene transfer from an RNA virus or a novel function in RNA processing.

**Orphan Intein**: Gene 541 represents a free-standing intein with structural similarity to archaeal inteins. Its presence outside a host protein context suggests it may be a mobile genetic element.

**Eukaryotic Machinery**: Complete transcription (TBP/TFIIB), ubiquitin, and histone systems enable host-independent gene expression and cellular reprogramming.

**Dark Matter**: {stats['giant_unannotated']} giant proteins (>=1000 aa) remain uncharacterized, representing substantial unexplored viral biology.

**DNA Modification**: 19 methyltransferases provide extensive DNA modification capability, likely for evading host restriction systems."""

    pdf.body_text(conclusions)

    pdf.section_title("Future Directions")
    future = [
        "Experimental validation of RdRp activity (Gene 584)",
        "Characterization of orphan intein splicing capability (Gene 541)",
        "AlphaFold2 prediction for proteins exceeding ESM3's 1024 aa limit",
        "Investigation of TnpB transposase activity and targets",
        "Comparative genomics with other NCLDVs",
        "Host range determination and infection mechanism"
    ]
    for item in future:
        pdf.add_bullet(item)

    # ==================== METHODS ====================
    print("Creating methods section...")
    pdf.add_page()
    pdf.chapter_title(9, 'Methods')

    methods = """**Data Processing**
- Protein sequences: Prodigal gene prediction
- Annotation: PFAM/KEGG via Astra HMM (evalue 1e-5), VOGdb (evalue 1e-15)
- Embeddings: ESM2 (facebook/esm2_t6_8M_UR50D, 320-dimensional)
- Database: DuckDB with LanceDB vector store

**Structure Prediction**
- Tool: ESM3 API (esm3-open-2024-03)
- Parameters: num_steps=8, track="structure"
- Limit: 1024 amino acid maximum length
- Output: PDB format coordinates

**Structural Homology Search**
- Tool: Foldseek API (https://search.foldseek.com)
- Databases: afdb50 (AlphaFold DB 50% clusters), pdb100 (PDB)
- Parameters: Default sensitivity

**Genome Exploration**
- Survey: Systematic annotation summary
- Exploration: Curiosity-driven locus discovery
- Structure analysis: ESM3 prediction + Foldseek search"""

    pdf.body_text(methods)

    # ==================== FILL TOC ====================
    print("Generating table of contents...")
    total_pages = pdf.page_no()
    pdf.page = toc_page
    pdf.set_y(toc_y_start)
    pdf.in_toc = True
    for num, title, page in pdf.toc_entries:
        pdf.add_toc_entry(num, title, page)
    pdf.in_toc = False
    pdf.page = total_pages

    # ==================== SAVE ====================
    print(f"\nSaving to {OUTPUT_PDF}...")
    pdf.output(str(OUTPUT_PDF))

    print("\n" + "=" * 60)
    print("COMPLETE")
    print("=" * 60)
    print(f"  Output: {OUTPUT_PDF}")
    print(f"  Pages: {total_pages}")
    print(f"  Figures: {pdf.figure_counter}")


if __name__ == "__main__":
    generate_report()
