#!/usr/bin/env python3
"""
Generate an expanded paper-style PDF report from Hinthialibacterota analysis.

Renders synthesis.md as a formatted scientific paper, expanded with content
from topic-specific exploration files (energy, defense, carbon, novel proteins,
viral landscape, ecotype analysis, genome case studies).
"""

import json
import os
import re
import sys
from pathlib import Path
from datetime import datetime
from collections import defaultdict

sys.path.insert(0, str(Path(__file__).parent.parent))

from fpdf import FPDF

import argparse
parser = argparse.ArgumentParser(description='Generate paper-style report')
parser.add_argument('--dataset', default='data/hinthialibacterota_production', help='Dataset directory')
args, _ = parser.parse_known_args()

DATASET_DIR = Path(args.dataset)
DB_PATH = str(DATASET_DIR / "sharur.duckdb")
EXPLORE_DIR = DATASET_DIR / "exploration"
FIGURES_DIR = EXPLORE_DIR / "figures"
STRUCTURES_DIR = DATASET_DIR / "structures"
SYNTHESIS_PATH = EXPLORE_DIR / "synthesis.md"
OUTPUT_PDF = DATASET_DIR / f"{DATASET_DIR.name}_paper_report.pdf"


def clean_text(text):
    """Clean text for PDF (Latin-1 encoding)."""
    if not text:
        return ""
    replacements = {
        '\u2192': '->', '\u2190': '<-', '\u2194': '<->',
        '\u2022': '*', '\u2013': '-', '\u2014': '--',
        '\u201c': '"', '\u201d': '"', '\u2018': "'", '\u2019': "'",
        '\u2026': '...', '\u2265': '>=', '\u2264': '<=',
        '\u00b1': '+/-', '\u00d7': 'x', '\u2248': '~',
        '\u0394': 'Delta', '\u03bc': 'mu',
    }
    for old, new in replacements.items():
        text = text.replace(old, new)
    text = text.encode('latin-1', 'replace').decode('latin-1')
    return text


class PaperReport(FPDF):
    """Paper-style PDF with proper academic formatting."""

    def __init__(self):
        super().__init__()
        self.set_auto_page_break(auto=True, margin=22)
        self.set_margins(left=25, top=20, right=25)
        self.figure_counter = 0
        self.current_section = ''

    def header(self):
        if self.page_no() > 1:
            self.set_font('Helvetica', 'I', 8)
            self.set_text_color(140, 140, 140)
            self.cell(0, 5, 'Hinthialibacterota Genomic Analysis', 0, 0, 'L')
            self.cell(0, 5, str(self.page_no()), 0, 0, 'R')
            self.ln(8)
            self.set_draw_color(200, 200, 200)
            self.set_line_width(0.2)
            self.line(25, 13, self.w - 25, 13)
            self.set_text_color(0, 0, 0)

    def footer(self):
        pass

    def title_page(self, title, subtitle, stats):
        self.add_page()
        self.ln(40)
        self.set_font('Helvetica', 'B', 18)
        self.set_text_color(30, 30, 30)
        self.multi_cell(0, 10, clean_text(title), align='C')
        self.ln(8)
        self.set_font('Helvetica', '', 12)
        self.set_text_color(80, 80, 80)
        self.multi_cell(0, 7, clean_text(subtitle), align='C')
        self.ln(15)
        self.set_draw_color(40, 60, 100)
        self.set_line_width(0.6)
        cx = self.w / 2
        self.line(cx - 30, self.get_y(), cx + 30, self.get_y())
        self.ln(15)
        self.set_font('Helvetica', '', 11)
        self.set_text_color(60, 60, 60)
        self.cell(0, 7, stats, 0, 1, 'C')
        self.ln(5)
        self.set_font('Helvetica', 'I', 10)
        self.set_text_color(120, 120, 120)
        self.cell(0, 7, datetime.now().strftime('February %Y'), 0, 1, 'C')
        self.ln(30)
        self.set_font('Helvetica', '', 9)
        self.set_text_color(150, 150, 150)
        self.cell(0, 5, 'Generated by Sharur Genomic Analysis Platform', 0, 1, 'C')

    def section_heading(self, title, level=2):
        if level == 2:
            self.ln(4)
            self.set_font('Helvetica', 'B', 14)
            self.set_text_color(30, 50, 90)
            self.multi_cell(0, 8, clean_text(title), align='L')
            self.set_draw_color(30, 50, 90)
            self.set_line_width(0.4)
            self.line(25, self.get_y(), 80, self.get_y())
            self.ln(4)
        elif level == 3:
            self.ln(3)
            self.set_font('Helvetica', 'B', 11)
            self.set_text_color(50, 70, 110)
            self.multi_cell(0, 7, clean_text(title), align='L')
            self.ln(2)
        self.set_text_color(0, 0, 0)

    def paragraph(self, text):
        if not text or not text.strip():
            return
        text = clean_text(text)
        text_plain = re.sub(r'\*\*([^*]+)\*\*', r'\1', text)
        self.set_font('Helvetica', '', 10)
        w = self.w - self.l_margin - self.r_margin
        self.multi_cell(w, 5, text_plain, align='L')
        self.ln(2)

    def bullet_item(self, text):
        text = clean_text(text)
        text = re.sub(r'\*\*([^*]+)\*\*', r'\1', text)
        self.set_x(self.l_margin + 5)
        self.set_font('Helvetica', '', 10)
        self.cell(4, 5, chr(149), 0, 0)
        w = self.w - self.get_x() - self.r_margin
        self.multi_cell(w, 5, text, align='L')
        self.ln(1)

    def render_table(self, rows, col_widths=None):
        """Render a table from a list of row-lists. First row is header."""
        if not rows:
            return
        n_cols = len(rows[0])
        available = self.w - self.l_margin - self.r_margin - 2
        if col_widths is None:
            col_widths = [available / n_cols] * n_cols

        if self.get_y() > self.h - 60:
            self.add_page()

        row_h = 6
        for i, row in enumerate(rows):
            if i == 0:
                self.set_font('Helvetica', 'B', 8)
                self.set_fill_color(40, 60, 100)
                self.set_text_color(255, 255, 255)
            else:
                self.set_font('Helvetica', '', 8)
                if i % 2 == 0:
                    self.set_fill_color(240, 242, 248)
                else:
                    self.set_fill_color(255, 255, 255)
                self.set_text_color(40, 40, 40)

            # Check page break
            if self.get_y() > self.h - 30:
                self.add_page()
                # Re-render header
                self.set_font('Helvetica', 'B', 8)
                self.set_fill_color(40, 60, 100)
                self.set_text_color(255, 255, 255)
                self.set_x(self.l_margin + 1)
                for j, cell in enumerate(rows[0]):
                    cell_t = clean_text(str(cell))[:50]
                    self.cell(col_widths[j], row_h, cell_t, 1, 0, 'L', True)
                self.ln(row_h)
                self.set_font('Helvetica', '', 8)
                self.set_fill_color(255, 255, 255)
                self.set_text_color(40, 40, 40)

            self.set_x(self.l_margin + 1)
            for j, cell in enumerate(row):
                cell_t = clean_text(str(cell))
                if len(cell_t) > 50:
                    cell_t = cell_t[:47] + '...'
                self.cell(col_widths[j], row_h, cell_t, 1, 0, 'L', True)
            self.ln(row_h)

        self.set_text_color(0, 0, 0)
        self.ln(4)

    def add_figure(self, fig_path, caption, max_width=160):
        if not os.path.exists(fig_path):
            return
        if self.get_y() > self.h - 100:
            self.add_page()
        self.ln(3)
        try:
            self.image(str(fig_path), x=(self.w - max_width) / 2, w=max_width)
        except Exception as e:
            self.paragraph(f"[Could not load figure: {e}]")
            return
        self.ln(3)
        self.set_font('Helvetica', '', 8.5)
        self.set_text_color(50, 50, 50)
        caption = clean_text(caption)
        match = re.match(r'(Figure \d+[A-Za-z]?\.)\s*(.*)', caption)
        if match:
            prefix = match.group(1)
            rest = match.group(2)
            self.set_x(self.l_margin + 5)
            self.set_font('Helvetica', 'B', 8.5)
            prefix_w = self.get_string_width(prefix + ' ')
            self.cell(prefix_w, 4, prefix + ' ', 0, 0)
            self.set_font('Helvetica', '', 8.5)
            w = self.w - self.get_x() - self.r_margin - 5
            self.multi_cell(w, 4, rest, align='L')
        else:
            w = self.w - self.l_margin - self.r_margin - 10
            self.set_x(self.l_margin + 5)
            self.multi_cell(w, 4, caption, align='L')
        self.set_text_color(0, 0, 0)
        self.set_font('Helvetica', '', 10)
        self.ln(5)


def fig(name):
    """Helper to get figure path."""
    return str(FIGURES_DIR / name)


def generate_report():
    print("=" * 60)
    print("EXPANDED PAPER-STYLE REPORT GENERATOR")
    print("=" * 60)

    # Get stats
    try:
        import duckdb
        db = duckdb.connect(DB_PATH, read_only=True)
        n_genomes = db.execute("SELECT COUNT(DISTINCT bin_id) FROM proteins").fetchone()[0]
        n_proteins = db.execute("SELECT COUNT(*) FROM proteins").fetchone()[0]
        db.close()
    except Exception:
        n_genomes = 41
        n_proteins = 184136

    pdf = PaperReport()
    fc = [0]  # mutable figure counter

    def next_fig():
        fc[0] += 1
        return fc[0]

    # ============================================================
    # TITLE PAGE
    # ============================================================
    print("  Title page...")
    pdf.title_page(
        title="Dual Electron Transfer Strategies in Hinthialibacterota",
        subtitle=("Genomic Evidence for H2-Mediated and Cytochrome-Based\n"
                  "Direct Interspecies Electron Transfer\n"
                  "with Partner-Docking Machinery"),
        stats=f"{n_genomes} genomes  |  {n_proteins:,} proteins  |  80 documented findings"
    )

    # ============================================================
    # ABSTRACT
    # ============================================================
    print("  Abstract...")
    pdf.add_page()
    pdf.section_heading("Abstract", level=2)
    pdf.paragraph(
        "Obligate syntrophs must transfer electrons to partner organisms to maintain "
        "thermodynamically favorable metabolism. Analysis of 41 Hinthialibacterota genomes "
        "reveals two distinct electron transfer strategies within this phylum. While 95% of "
        "genomes (39/41) encode validated NiFe hydrogenases for H2-mediated syntrophy, two "
        "genomes completely lack hydrogenase genes and instead possess MtrC/MtrF-type outer "
        "membrane cytochrome conduits homologous to Geobacter ImcH (40% sequence identity, "
        "Foldseek E-value 4.85e-45). A 43-heme giant cytochrome (1,878 aa) fused to a "
        "dockerin domain provides evidence for partner-docking electron conduits. Fifteen "
        "genomes contain dockerin-cytochrome proteins without cognate cohesins, suggesting "
        "they dock to syntrophic partners rather than self. Unlike Geobacter, Hinthialibacterota "
        "lack aromatic-enriched pilins (5.3% vs 9% aromatic content), indicating cytochrome-only "
        "DIET without conductive pili. Universal benzoyl-CoA reductase (41/41 genomes) and "
        "extensive glycoside hydrolase repertoires identify aromatic compounds and host glycans "
        "as primary carbon sources. A massive defense arsenal -- dominated by Paris, BREX, and "
        "restriction-modification systems rather than CRISPR-Cas -- protects against persistent "
        "phage pressure. Structure prediction of 12 key proteins using ESM3 confirmed the "
        "identity of a KAP NTPase defense protein, a porin-like conduit pore, and a dockerin "
        "domain linking to Methanosarcinales partners. These findings establish that DIET can "
        "evolve convergently through distinct molecular mechanisms and reveal an unexpectedly "
        "complex syntrophic biology."
    )

    # ============================================================
    # RESULTS
    # ============================================================
    print("  Results...")
    pdf.add_page()
    pdf.section_heading("Results", level=2)

    # --- Section 1: Electron transfer strategies ---
    print("    1. Electron transfer strategies...")
    pdf.section_heading("Two Distinct Electron Transfer Strategies", level=3)
    pdf.paragraph(
        "Hydrogenase validation using HydDB HMMs with PFAM domain confirmation revealed a "
        "striking distribution: 39 of 41 genomes (95%) encode validated NiFe hydrogenase "
        "catalytic subunits (NiFeSe_Hases domain, PF00374), while two genomes "
        "(GCA_029261095_1 and GCA_020632575_1) completely lack hydrogenase genes. "
        "The hydrogenase-encoding genomes are dominated by Group 3 bidirectional hydrogenases "
        "(83/101 validated, 82%), specifically Group 3d NAD(P)-reducing (47 proteins in 36 "
        "genomes) and Group 3c methyl-viologen reducing (22 proteins in 21 genomes). Group 1a "
        "uptake hydrogenases (13 proteins in 12 genomes) and Group 3b bifunctional (12 proteins "
        "in 11 genomes) complete the main repertoire, with a single validated Group 4g "
        "energy-conserving hydrogenase and rare Group 3a F420-reducing (2 proteins)."
    )
    pdf.paragraph(
        "Notably, 78 HydDB hits to Group 4 were invalidated as Complex I respiratory subunits "
        "lacking the NiFeSe_Hases catalytic domain, representing a 44% false positive rate that "
        "underscores the importance of domain-based validation. The two hydrogenase-lacking "
        "genomes instead possess 56-76 cytochrome proteins (5-7 fold higher than H2 producers), "
        "including a conserved cytochrome electron conduit: Cytochrom_c3_2 to cytochrome b to "
        "cytochrome C554 to Cytochrom_NNT. This identical gene arrangement in both genomes, "
        "despite differing assembly quality (119 vs 725 contigs), validates the DIET phenotype "
        "as genuine biology rather than assembly artifact."
    )

    # Figure 1: Electron transfer strategies
    fn = next_fig()
    pdf.add_figure(fig('fig1_electron_transfer_strategies.png'),
        f'Figure {fn}. Electron transfer strategies in Hinthialibacterota. '
        '(A) Scatter plot of hydrogenase gene count versus electron transfer gene count for each genome, '
        'colored by ecotype. DIET genomes (red) cluster at zero hydrogenases with elevated '
        'electron transfer genes. (B) Distribution of the 41 genomes across three ecotype categories.')

    # Figure 2: Hydrogenase classification (fixed)
    fn = next_fig()
    pdf.add_figure(fig('fig5_hydrogenase_classification.png'),
        f'Figure {fn}. Hydrogenase subgroup classification across Hinthialibacterota. '
        '(A) Distribution of 101 validated hydrogenases by HydDB subgroup. Group 3d NAD(P)-reducing '
        'dominates (47 proteins, 36 genomes), followed by Group 3c Mvh (22), Group 1a uptake (13), '
        'and Group 3b bifunctional (12). FeFe hydrogenases (4 proteins, 1 genome) are likely '
        'contaminants. (B) Per-genome hydrogenase repertoire showing subgroup diversity.')

    # --- Section 2: MtrC/MtrF ---
    print("    2. MtrC/MtrF cytochromes...")
    pdf.section_heading("MtrC/MtrF Outer Membrane Cytochromes Enable Extracellular Electron Transfer", level=3)
    pdf.paragraph(
        "Foldseek structural homology searches confirmed that the predicted 6-heme cytochrome "
        "in DIET genomes (JACKFH010000001.1_398, 507 aa) is structurally homologous to Geobacter "
        "ImcH (UniProt Q747K6), a key inner membrane cytochrome essential for extracellular "
        "electron transfer. The structural alignment yielded 40.3% sequence identity (E-value "
        "4.85e-45), supporting functional conservation of the electron transfer mechanism."
    )
    pdf.paragraph(
        "MtrC/MtrF outer membrane cytochrome domains (Mtrc-MtrF_II-IV_dom) are present in 44 "
        "proteins across 31 of 41 genomes (76%). This widespread distribution suggests latent "
        "DIET capability throughout the phylum. Five genomes represent dedicated DIET specialists "
        "with elevated cytochrome-to-hydrogenase ratios: GCA_029261095_1 (85 heme proteins, zero "
        "hydrogenases), GCA_022072055_1, GCA_013360775_1, GCA_020430105_1, and GCA_020632575_1."
    )

    fn = next_fig()
    pdf.add_figure(fig('diet_cytochrome_conduit_GCA_020632575_1.png'),
        f'Figure {fn}. Cytochrome electron conduit locus in DIET genome GCA_020632575_1. '
        'The conserved arrangement Cytochrom_c3_2 -> cytochrome b -> C554 -> Cytochrom_NNT forms '
        'a complete electron path from cytoplasmic oxidation through the periplasm to the cell surface.')

    # --- Section 3: 43-heme giant cytochrome ---
    print("    3. 43-heme giant cytochrome...")
    pdf.section_heading("A 43-Heme Giant Cytochrome with Partner-Docking Architecture", level=3)
    pdf.paragraph(
        "The most striking discovery is a 1,878 aa cytochrome containing 43 CxxCH heme-binding "
        "motifs and a C-terminal Dockerin_1 domain (JACKFH010000004.1_51 in genome "
        "GCA_020632575_1). This protein combines three MtrC-MtrF outer membrane cytochrome "
        "domain regions interspersed with cytochrome c heme-binding clusters, suggesting it "
        "functions as a partner-docking electron conduit -- a molecular wire capped with a "
        "docking module."
    )
    pdf.paragraph(
        "Syntenic analysis reveals two cohesin receptors (genes 59 and 61, 321-372 aa) encoded "
        "9-11 genes downstream on the opposite strand. Two-component regulatory elements (Sigma54 "
        "activator, HisKA sensor kinase) and an ECF sigma factor flank the locus, indicating "
        "tight transcriptional control. A CsgG-containing secretion protein (gene 64) unique to "
        "this genome may facilitate cytochrome complex assembly and export."
    )

    fn = next_fig()
    pdf.add_figure(fig('fig3_43heme_domain_architecture.png'),
        f'Figure {fn}. Domain architecture of the 43-heme giant cytochrome (1,877 aa). '
        'Three MtrC-MtrF outer membrane cytochrome regions (blue) are interspersed with cytochrome c '
        'heme-binding clusters (red, 43 CxxCH motifs). A C-terminal Dockerin_1 domain (green) '
        'mediates attachment to cohesin receptors on partner organisms.')

    fn = next_fig()
    pdf.add_figure(fig('DIET_locus_43heme.png'),
        f'Figure {fn}. Genomic context of the 43-heme cytochrome locus in GCA_020632575_1. '
        'The 43-heme dockerin-cytochrome is flanked by regulatory elements (Sigma54, HisKA) '
        'and two cohesin receptors (genes 59, 61). A CsgG secretion channel (gene 64) may facilitate '
        'complex assembly.')

    # --- Section 4: Orphan dockerins ---
    print("    4. Orphan dockerin genomes...")
    pdf.section_heading("Orphan Dockerin Genomes and Trans-Species Docking", level=3)
    pdf.paragraph(
        "Fifteen of 41 genomes (37%) encode dockerin-containing cytochromes but completely lack "
        "cohesin receptors. Since dockerin domains require cohesin binding partners for attachment, "
        "these 'orphan' dockerins must bind cohesins expressed by syntrophic partner organisms "
        "(likely methanogens), providing a molecular mechanism for interspecies cell-cell contact."
    )
    pdf.paragraph(
        "Orphan dockerin genomes differ significantly from cohesin-containing genomes across "
        "multiple features. They are 20% smaller (3,854 +/- 716 vs 4,837 +/- 942 proteins, "
        "Mann-Whitney U=66, p=0.001), have 1.27-fold higher transporter density (72.4 vs 56.9 "
        "per 1000 proteins, p<0.001), carry fewer defense genes (20.3 vs 29.8 per 1000, p=0.001), "
        "and show reduced CRISPR prevalence (47% vs 88%, Fisher p=0.010). These smaller genomes "
        "with enhanced transporter capacity and reduced defense are consistent with an obligate "
        "partner-dependent lifestyle."
    )
    pdf.paragraph(
        "A DUF4384+Caspase protein (485 aa) is exclusive to orphan dockerin genomes. ESM3 "
        "structure prediction (pLDDT 0.73) confirmed the caspase fold, with Foldseek hits to "
        "Candidatus Moduliflexus flocculans and Desulfobacterales -- both syntrophic lineages. "
        "This may represent a programmed cell death effector unique to partner-dependent organisms."
    )

    fn = next_fig()
    pdf.add_figure(fig('fig2_ecotype_comparison.png'),
        f'Figure {fn}. Genomic features of orphan dockerin versus cohesin-containing genomes. '
        '(A) Genome size: orphan genomes are significantly smaller (p=0.001). '
        '(B) Transporter density: orphan genomes have 1.27-fold higher transporter content (p<0.001). '
        '(C) Defense genes: orphan genomes have fewer (p=0.001). '
        '(D) CRISPR-Cas: 47% of orphan vs 88% of cohesin+ genomes (p=0.010).')

    fn = next_fig()
    pdf.add_figure(fig('orphan_dockerin_1490aa_locus.png'),
        f'Figure {fn}. Orphan dockerin protein locus (1,490 aa) with dockerin-cytochrome architecture '
        'but no nearby cohesin receptors. Present in 15/41 genomes, suggesting docking to '
        'partner-expressed cohesins.')

    # --- Section 5: Conductive pili ---
    print("    5. DIET without pili...")
    pdf.section_heading("DIET Operates Without Conductive Pili", level=3)
    pdf.paragraph(
        "Analysis of pilin aromatic amino acid content (Phe, Tyr, Trp residues, which mediate "
        "electron transfer in conductive pili) revealed that DIET genomes have lower aromatic "
        "content than H2 producers (5.27% vs 6.66% mean). Geobacter conductive PilA contains "
        "approximately 9% aromatic residues. No T4P or Tad structural pilins were detected in "
        "DIET genomes. This indicates that Hinthialibacterota DIET operates through a "
        "cytochrome-only mechanism, distinct from the pili-dependent DIET of Geobacter."
    )

    # --- Section 6: Rnf complex ---
    pdf.section_heading("Rnf Complex Provides Energy Conservation in DIET Genomes", level=3)
    pdf.paragraph(
        "Both DIET genomes contain complete Rnf complex operons (RnfC with 6 ferredoxin domains, "
        "NQR2/RnfD/RnfE membrane subunits, FMN-binding protein). Since these genomes lack "
        "hydrogenases, Rnf represents the only energy-conserving mechanism, coupling ferredoxin "
        "oxidation to membrane potential generation for ATP synthesis. The Rnf complex is also "
        "present in 13 additional genomes, where it supplements hydrogenase-based energy conservation."
    )

    # --- Section 7: Carbon metabolism (NEW expanded section) ---
    print("    6. Carbon metabolism...")
    pdf.add_page()
    pdf.section_heading("Carbon Substrate Utilization", level=3)
    pdf.paragraph(
        "Hinthialibacterota show a distinctive metabolic profile as obligate syntrophs. Benzoyl-CoA "
        "reductase (BcrAD_BadFG) is universally present across all 41 genomes (64 total copies), "
        "catalyzing the ATP-dependent reduction of the aromatic ring -- the rate-limiting step in "
        "anaerobic aromatic degradation. This universality identifies aromatic compounds (benzoate, "
        "phenylacetate, phenylalanine) as primary carbon sources, consistent with Hinthialibacterota "
        "ecology in anaerobic sediments where aromatic compounds accumulate from lignin degradation."
    )
    pdf.paragraph(
        "Unlike many syntrophs and acetogens, most Hinthialibacterota do NOT have a complete "
        "Wood-Ljungdahl pathway for CO2 fixation. Only GCA_029568995_1 has a complete pathway "
        "(CODH alpha, ACS beta/delta subunits). Three additional genomes have CdhD only. "
        "Twenty-six genomes have Prismane/CO dehydrogenase domains but lack the catalytic core. "
        "Hinthialibacterota are therefore not acetogens, distinguishing them from Syntrophomonas "
        "and Thermacetogenium."
    )
    pdf.paragraph(
        "Extensive glycoside hydrolase (GH) repertoires indicate versatile carbohydrate metabolism. "
        "GH33 sialidases (602 proteins) suggest host glycoprotein degradation; GH78 rhamnosidases "
        "(440 proteins) indicate plant cell wall polysaccharide utilization; GH29 fucosidases (366 "
        "proteins) support mucin/glycoconjugate degradation. Multiple cellulase (GH5, GH9) and "
        "xylanase (GH10) families indicate plant biomass capacity. The enormous GT2 (5,074 proteins) "
        "and GT4 (3,815 proteins) glycosyltransferase repertoires suggest complex cell surface "
        "glycan biosynthesis critical for syntrophic partner recognition."
    )
    pdf.paragraph(
        "Fatty acid beta-oxidation capacity varies significantly: while 3-hydroxyacyl-CoA "
        "dehydrogenase is present in 35/41 genomes, enoyl-CoA hydratase (ECH) is found in only "
        "16/41. The DIET candidate GCA_029261095_1 has the highest BCD/ETF count (8 proteins) and "
        "beta-oxidation enzymes (10 proteins), suggesting fatty acid oxidation as a primary electron "
        "source for cytochrome-based electron transfer. Pyruvate:ferredoxin oxidoreductase (PFOR) "
        "is present in all 41 genomes (65 copies total), serving as the central link between "
        "glycolysis and electron disposal. Methanol utilization via MtaB (methanol:cobalamin "
        "methyltransferase) is found in 15/41 genomes, providing an alternative electron source."
    )

    fn = next_fig()
    pdf.add_figure(fig('carbon_benzoyl_CoA_locus.png'),
        f'Figure {fn}. Benzoyl-CoA reductase locus showing the anaerobic aromatic degradation '
        'operon. Present in all 41 genomes, indicating universal capacity for aromatic compound '
        'metabolism.')

    fn = next_fig()
    pdf.add_figure(fig('carbon_CAZy_cluster.png'),
        f'Figure {fn}. Glycoside hydrolase gene cluster showing the diversity of carbohydrate-active '
        'enzymes. Sialidases (GH33), rhamnosidases (GH78), and fucosidases (GH29) suggest host '
        'glycan degradation capacity.')

    # --- Section 8: Cell surface (NEW expanded section) ---
    print("    7. Cell surface machinery...")
    pdf.section_heading("Cell Surface and Partnership Machinery", level=3)
    pdf.paragraph(
        "As obligate syntrophs, Hinthialibacterota depend on cell-cell contact with partner "
        "organisms. All 41 genomes encode complete flagellar systems (1-9 flagellin proteins per "
        "genome, median 4), providing motility to locate syntrophic partners. Type IV pili (T4P) "
        "machinery is also universal, with PilM_2 (2-5 copies per genome), PilO, PilN, and PilZ "
        "components. However, no PilA-like aromatic-rich pilins typical of conductive DIET pili "
        "were detected; T4P in Hinthialibacterota appear to function primarily in twitching "
        "motility and biofilm formation."
    )
    pdf.paragraph(
        "A subset of genomes (16/41, 39%) encode complete Tad (Tight adherence) pilus operons "
        "for irreversible attachment. Giant adhesin proteins mediate partner recognition: "
        "Laminin_G_3 eukaryote-like adhesins, CARDB cell adhesion domains, and LysM "
        "peptidoglycan-binding domains are widespread. The largest genome (GCA_963663405_1, "
        "7,544 proteins) has 28 adhesin proteins including a 1,749 aa Laminin_G/CotH adhesin "
        "and a 1,474 aa CARDB adhesin. DIET genome GCA_029261095_1 has a massive expansion of "
        "FG-GAP adhesin repeats (190 total) and two giant secretin proteins (2,158 and 1,598 aa), "
        "suggesting specialized secretion of outer membrane cytochromes."
    )

    fn = next_fig()
    pdf.add_figure(fig('GCA_963663405_1_giant_adhesin.png'),
        f'Figure {fn}. Giant Laminin_G adhesin locus (1,749 aa) in the largest Hinthialibacterota '
        'genome (GCA_963663405_1). Eukaryotic-like adhesin domains mediate cell-cell contact '
        'essential for syntrophic partnerships.')

    # --- Section 9: Defense systems (NEW expanded section) ---
    print("    8. Defense systems...")
    pdf.add_page()
    pdf.section_heading("Defense System Landscape", level=3)
    pdf.paragraph(
        "Hinthialibacterota genomes harbor an exceptionally diverse defense arsenal. Unlike many "
        "obligate syntrophs with reduced defense, this phylum maintains robust antiphage systems: "
        "10,130 defense proteins (5.5% of proteome), with a remarkably narrow range (4.6-6.5%) "
        "across all 41 genomes. This consistency suggests defense maintenance is under strong "
        "selection, reflecting ongoing phage pressure in anaerobic habitats."
    )
    pdf.paragraph(
        "The dominant defense systems are Paris (1,547 proteins, ATPase-based antiphage), "
        "restriction-modification (1,003 proteins), BREX bacteriophage exclusion (556 proteins), "
        "Viperin radical SAM antiviral (458 proteins), and Gabija abortive infection (419 proteins). "
        "CBASS cyclic nucleotide signaling (380 proteins) and DISARM (205 proteins) are also "
        "widespread. Several novel systems were identified, including Thoeris-NLR proteins with "
        "eukaryotic-like NACHT domains suggesting innate immune signaling."
    )
    pdf.paragraph(
        "In contrast, CRISPR-Cas adaptive immunity is surprisingly minimal. No complete Type I, "
        "II, or III CRISPR-Cas operons were detected in most genomes. The 45 identified CRISPR "
        "loci include 32 Type I, 12 Type III, and 1 Type V-B system, but many are fragmentary. "
        "Only GCA_029558215_1 -- the FeFe hydrogenase outlier -- has a complete Type I-D CRISPR "
        "system with full Cascade complex and adaptation module. This heavy reliance on innate "
        "immunity (RM, BREX, DISARM, Paris) rather than adaptive immunity (CRISPR) is unusual "
        "for bacteria with this level of overall defense investment."
    )

    fn = next_fig()
    pdf.add_figure(fig('fig7_defense_landscape.png'),
        f'Figure {fn}. Defense system landscape across ecotypes. '
        '(A) Defense gene density versus genome size, showing orphan dockerin genomes (orange) '
        'have consistently lower defense investment than cohesin+ genomes (blue). '
        '(B) CRISPR-Cas gene content by ecotype. DIET genomes have the lowest CRISPR content.')

    fn = next_fig()
    pdf.add_figure(fig('defense_brex_disarm_dnd_island.png'),
        f'Figure {fn}. Triple defense system island in GCA_040755155_1 showing BREX, DISARM, '
        'and Dnd (phosphorothioation) co-localized on a single contig. This layered DNA '
        'modification-based defense provides multiple barriers against phage infection.')

    fn = next_fig()
    pdf.add_figure(fig('defense_thoeris_nlr_locus.png'),
        f'Figure {fn}. Thoeris-NLR defense locus in GCA_963663405_1. A 506 aa protein with '
        'NACHT domain (NLR-like), SEFIR domain, and Thoeris signatures paired with a TIR domain '
        'protein. This architecture resembles eukaryotic innate immune receptors.')

    # --- Section 10: Novel proteins (NEW expanded section) ---
    print("    9. Novel proteins...")
    pdf.section_heading("Novel Protein Discovery", level=3)
    pdf.paragraph(
        "Hinthialibacterota genomes contain a substantial reservoir of unannotated proteins, "
        "including 869 'giant' unknowns over 800 aa with no PFAM domain hits at standard "
        "thresholds. Several categories of novel proteins were identified through systematic "
        "analysis using relaxed e-value thresholds, genomic context, and structural prediction."
    )
    pdf.paragraph(
        "The largest unannotated protein in the phylum (JAJVIK010000008.1_48, 5,461 aa in genome "
        "GCA_022072055_1) was initially reported as completely unknown. Re-analysis with relaxed "
        "PFAM thresholds (e-value 1e-5 vs standard bitscore cutoffs) revealed 8 bacterial Ig-like "
        "domains (Big_13 and Big_3_3) at four distinct positions (443-563, 749-914, 1071-1169, "
        "1859-1960). These domains are characteristic of fibrillar adhesins that mediate cell-cell "
        "contact. Combined with high glycine (10.3%) and valine (10.3%) content suggesting "
        "beta-sheet rich structure, this protein is likely a giant syntrophic adhesin bridging "
        "the gap between Hinthialibacterota and methanogenic partners. At ~570 kDa estimated "
        "molecular weight, it would form an exceptionally long filament (compare: Staphylococcus "
        "FnBPA is only 1,018 aa with 4 Ig-like domains)."
    )
    pdf.paragraph(
        "A conserved 4,389 aa protein with no domain annotations is present in 4 genomes with "
        "98.4% sequence identity and perfect synteny conservation (flanked by Radical_SAM, tRNA "
        "synthetases upstream; Rotamase, Wzy_C polymerase, MutS downstream). The Wzy_C context "
        "suggests involvement in cell surface polysaccharide assembly. A DUF5117/DUF5118/DUF4953 "
        "(Met-zincin metalloprotease) combination is present in 20-21 genomes (~50%) and appears "
        "to be Hinthialibacterota-specific. In the DIET genome GCA_029261095_1, a 3,948 aa unknown "
        "adjacent to Type II Secretion System components may function in secreting or assembling "
        "the cytochrome conduits that enable direct electron transfer."
    )

    fn = next_fig()
    pdf.add_figure(fig('hydrogenase_giant_unknown_neighborhood.png'),
        f'Figure {fn}. Genomic neighborhood of the 5,461 aa giant protein in an energy metabolism '
        'locus containing NiFe hydrogenase cytochrome b, NrfD, and ferredoxin proteins. '
        'Relaxed PFAM search revealed 8 Ig-like domains identifying this as a fibrillar adhesin.')

    fn = next_fig()
    pdf.add_figure(fig('conserved_4389aa_unknown_neighborhood.png'),
        f'Figure {fn}. Conserved 4,389 aa unknown protein with perfect synteny in 4 genomes. '
        'Flanked by Radical_SAM enzymes and Wzy_C polymerase, suggesting a role in cell surface '
        'polysaccharide assembly relevant to syntrophic partnerships.')

    # --- Section 11: Viral landscape (NEW section) ---
    print("    10. Viral landscape...")
    pdf.add_page()
    pdf.section_heading("Viral Landscape and Prophage Content", level=3)
    pdf.paragraph(
        "VOGdb annotation identified 42,727 proteins (23.2% of the proteome) with viral "
        "orthologous group matches across 2,418 unique VOGs. Viral content is remarkably "
        "consistent across the phylum (19.6-27.3%), suggesting stable host-phage coevolution "
        "rather than variable infection pressure. The majority of VOG hits fall into 'unknown' "
        "(Xu, 57,529) and 'host-beneficial' (Xh, 33,682) categories, indicating extensive "
        "phage-mediated horizontal gene transfer with many VOGs representing auxiliary metabolic "
        "genes rather than core phage functions."
    )
    pdf.paragraph(
        "Prophage completeness scoring (based on terminase, portal, head, tail, and lysis modules) "
        "identified only 5 contigs with all 5 core modules, suggesting most prophages are degraded "
        "or cryptic. However, 791 putative prophage regions with 5+ consecutive VOG-annotated "
        "genes were found, with the largest spanning 14-15 genes. Several genomes carry giant "
        "NRPS-like biosynthetic proteins (up to 7,341 aa) with VOGdb homology, suggesting "
        "these clusters may have been subject to phage-mediated horizontal gene transfer, "
        "though they likely represent chromosomal bacterial BGCs rather than active phage cargo."
    )
    pdf.paragraph(
        "Extensive defense-prophage co-localization (5,962 pairs of defense genes within 10 genes "
        "of phage structural proteins) suggests defense islands evolve within or adjacent to "
        "integrated phages. Paris (214 co-localization events), Mokosh (188), and PD-T4-6 (159) "
        "are the most frequently prophage-associated defense systems."
    )

    fn = next_fig()
    pdf.add_figure(fig('complete_prophage_JBFMBP010000039.png'),
        f'Figure {fn}. Complete prophage in GCA_040755155_1 with all structural modules: '
        'terminase (DNA packaging), portal vertex, head/capsid, tail assembly, and lysis genes. '
        'Only 5 such complete prophages were identified across 41 genomes.')

    # --- Section 12: Ecotype analysis (NEW section) ---
    print("    11. Ecotype analysis...")
    pdf.section_heading("Ecotype Analysis Reveals Three Metabolic Groups", level=3)
    pdf.paragraph(
        "Hierarchical clustering of 41 genomes using 14 metabolic and cell surface features "
        "(normalized per 1000 proteins, Ward's linkage) identified three distinct ecotypes. "
        "Ecotype 1 ('H2-Producers', 16 genomes) has the highest hydrogenase density (2.14/1000 "
        "proteins), low heme content (4.78/1000), and high iron-sulfur proteins (29.78/1000). "
        "Ecotype 2 ('DIET-Specialists', 5 genomes) has zero to low hydrogenase (0.75/1000), the "
        "highest heme content (13.76/1000), and MtrC/MtrF outer membrane cytochromes. Ecotype 3 "
        "('Core Hinthialibacterota', 20 genomes) shows a balanced profile with moderate values "
        "and the smallest average genome size (3,932 proteins)."
    )
    pdf.paragraph(
        "ANOVA confirms significant differences across ecotypes for heme-binding (F=83.75, "
        "p<0.0001), cytochrome C (F=54.65, p<0.0001), iron-sulfur (F=17.36, p<0.0001), "
        "MtrC/MtrF (F=16.13, p<0.0001), and hydrogenase (F=11.69, p=0.0001). The strong "
        "negative correlation between hydrogenase and heme-binding content (r=-0.71) confirms "
        "these strategies are mutually exclusive at the genome level."
    )

    fn = next_fig()
    pdf.add_figure(fig('ecotype_heatmap.png'),
        f'Figure {fn}. Ecotype feature heatmap showing 14 metabolic features across 41 genomes '
        'organized by hierarchical clustering. Three ecotypes emerge: H2-Producers (high '
        'hydrogenase, low heme), DIET-Specialists (zero hydrogenase, high heme), and Core '
        'Hinthialibacterota (balanced profiles).')

    fn = next_fig()
    pdf.add_figure(fig('ecotype_dendrogram.png'),
        f'Figure {fn}. Hierarchical clustering dendrogram of 41 Hinthialibacterota genomes '
        'based on 14 metabolic features. Three main clusters correspond to H2-Producers, '
        'DIET-Specialists, and Core Hinthialibacterota ecotypes.')

    # ============================================================
    # GENOME CASE STUDIES (NEW section)
    # ============================================================
    print("  Genome case studies...")
    pdf.add_page()
    pdf.section_heading("Genome Case Studies", level=2)

    # GCA_029261095_1 - DIET specialist
    pdf.section_heading("GCA_029261095_1: The DIET Specialist", level=3)
    pdf.paragraph(
        "This genome (5,736 proteins, 725 contigs) represents the most extreme metabolic outlier "
        "in the dataset. It is the only genome with zero true hydrogenases yet maintains 85 "
        "heme-binding proteins. Twenty cytochrome C proteins, 10 cbb3-type cytochromes, 8 "
        "pentaheme cytochrome C554, and 2 MtrC/MtrF-type outer membrane cytochromes form a "
        "complete electron conduit from cytoplasmic oxidation to the cell exterior."
    )
    pdf.paragraph(
        "The massive expansion of FG-GAP adhesin domains (190 total, vs 50-80 in typical genomes) "
        "suggests extensive cell-cell contact machinery essential for DIET. Two tandem giant "
        "secretin proteins (2,158 and 1,598 aa) adjacent to PilN suggest a specialized "
        "secretion/pilus system for exporting outer membrane cytochromes. A TcdB-like toxin "
        "(2,315 aa) with ADP-ribosyltransferase and adhesin domains may function in bacterial "
        "competition or partner signaling."
    )
    pdf.paragraph(
        "Despite lacking hydrogenases, the DIET genome has the highest beta-oxidation enzyme "
        "count (10 proteins) and BCD/ETF content (8 proteins), indicating fatty acid oxidation "
        "as a primary electron source for cytochrome-based transfer. The methyltransferase "
        "repertoire is also expanded (55 Methyltransf_11 proteins). Defense investment is below "
        "average (4.92% vs 5.5% mean), potentially reflecting reduced phage exposure in stable "
        "DIET partnerships requiring direct cell contact."
    )

    fn = next_fig()
    pdf.add_figure(fig('GCA_029261095_1_MtrC_locus.png'),
        f'Figure {fn}. MtrC outer membrane cytochrome locus in the DIET specialist genome '
        'GCA_029261095_1, showing the complete electron conduit from POR (pyruvate:ferredoxin '
        'oxidoreductase) through periplasmic cytochromes to the outer membrane MtrC-MtrF domain.')

    # GCA_029558215_1 - FeFe outlier
    pdf.section_heading("GCA_029558215_1: The FeFe Hydrogenase Outlier", level=3)
    pdf.paragraph(
        "This genome (5,780 proteins, 1,263 contigs) is the only Hinthialibacterota with FeFe "
        "hydrogenases -- five proteins with Fe_hyd_lg_C domains, including one with HisKA "
        "histidine kinase domains suggesting it functions as a sensory H2-dependent regulator. "
        "FeFe hydrogenases produce H2 at 10-100x the rate of NiFe hydrogenases but are "
        "oxygen-sensitive, suggesting this organism is adapted for rapid H2 production in "
        "strictly anaerobic conditions. Three NiFeSe (selenium-containing) hydrogenases provide "
        "additional catalytic diversity."
    )
    pdf.paragraph(
        "An electron-bifurcating FeFe hydrogenase complex was identified, coupling a large "
        "subunit with Complex1_51K (NAD-binding) and 2Fe-2S thioredoxin -- enabling "
        "thermodynamically unfavorable H2 release by coupling it with exergonic ferredoxin "
        "reduction. The genome has the highest ferredoxin count (235 domains) supporting "
        "extensive electron transfer networks, the most complete Wood-Ljungdahl pathway among "
        "all genomes, and the only complete Type I-D CRISPR-Cas system with full Cascade "
        "complex and adaptation module."
    )

    fn = next_fig()
    pdf.add_figure(fig('fefe_hydrogenase_locus.png'),
        f'Figure {fn}. FeFe hydrogenase locus in GCA_029558215_1, the only Hinthialibacterota '
        'genome with FeFe hydrogenases. These are likely contaminant sequences based on '
        'atypical domain architecture and phylogenetic incongruence with the rest of the phylum.')

    fn = next_fig()
    pdf.add_figure(fig('GCA_029558215_1_CRISPR.png'),
        f'Figure {fn}. Complete Type I-D CRISPR-Cas system in GCA_029558215_1, the only '
        'genome with a fully functional adaptive immune system. Includes Cas3 helicase-nuclease, '
        'Cascade complex (Cas5d, Csd1, Cas7), and adaptation module (Cas1, Cas2, Cas4).')

    # ============================================================
    # DISCUSSION
    # ============================================================
    print("  Discussion...")
    pdf.add_page()
    pdf.section_heading("Discussion", level=2)

    pdf.section_heading("Convergent Evolution of DIET", level=3)
    pdf.paragraph(
        "The discovery of cytochrome-based DIET in Hinthialibacterota, independent of conductive "
        "pili, demonstrates that direct interspecies electron transfer can evolve through multiple "
        "molecular mechanisms. While Geobacter employs aromatic-enriched PilA nanowires coated "
        "with OmcS cytochromes, Hinthialibacterota achieve electron transfer solely through "
        "MtrC/MtrF-type cytochrome conduits. The structural homology to Geobacter ImcH (40% "
        "identity, E=4.85e-45) suggests functional conservation of the underlying electron "
        "transfer chemistry despite divergent surface architectures. The absence of conductive "
        "pili eliminates the need for specialized aromatic-rich pilins, simplifying the genetic "
        "requirements for DIET evolution."
    )

    pdf.section_heading("Cohesin-Dockerin Systems in Interspecies Partnerships", level=3)
    pdf.paragraph(
        "Cohesin-dockerin interactions are well-characterized in cellulosome assembly but have "
        "not been previously implicated in interspecies electron transfer. The identification "
        "of orphan dockerin genomes (dockerin-cytochromes without self-cohesins) suggests these "
        "domains mediate physical attachment to partner organisms. ESM3 structure prediction of "
        "the protein between two cohesins (gene 61) revealed it is itself a cohesin variant, "
        "with a Foldseek hit to a dockerin domain in Methanosarcinales archaea (E=2.1e-11). "
        "This directly supports the hypothesis that the cohesin-dockerin machinery mediates "
        "trans-species docking, with methanogens as the likely partners."
    )

    pdf.section_heading("Thermodynamic Advantages of Dual Strategies", level=3)
    pdf.paragraph(
        "The coexistence of H2-based and cytochrome-based electron transfer within a single "
        "phylum may reflect niche partitioning. H2 diffusion permits partner flexibility but "
        "requires maintaining low H2 partial pressure. Direct cytochrome contact eliminates "
        "diffusion constraints but requires physical proximity and compatible surface proteins. "
        "The Group 3 bidirectional hydrogenases that dominate H2-producing genomes can perform "
        "electron bifurcation, coupling thermodynamically favorable ferredoxin reduction with "
        "unfavorable H2 release to enable syntrophy at very low H2 concentrations."
    )

    pdf.section_heading("A Comprehensive Syntrophic Biology", level=3)
    pdf.paragraph(
        "Beyond electron transfer, Hinthialibacterota reveal a sophisticated syntrophic biology. "
        "Universal aromatic degradation via benzoyl-CoA reductase, extensive glycan hydrolysis "
        "capacity (sialidases, fucosidases, rhamnosidases), and variable fatty acid oxidation "
        "provide diverse carbon substrates. Giant fibrillar adhesins (up to 5,461 aa with "
        "bacterial Ig-like domains) and Tad tight adherence pili mediate the physical contact "
        "essential for syntrophic partnerships. The massive defense arsenal -- dominated by "
        "innate immunity systems (Paris, BREX, RM) rather than adaptive CRISPR-Cas -- protects "
        "against persistent phage pressure while maintaining genome plasticity."
    )

    pdf.section_heading("Reduced Defense in Stable Consortia", level=3)
    pdf.paragraph(
        "The lower defense burden in orphan dockerin genomes (20.3 vs 29.8 defense genes per "
        "1000 proteins, p=0.001) and reduced CRISPR prevalence (47% vs 88%) support the "
        "hypothesis that stable syntrophic partnerships reduce exposure to horizontal gene "
        "transfer and phage predation. The consistent overall defense investment (4.6-6.5% "
        "across all genomes) nevertheless indicates that phage pressure remains a major "
        "selective force throughout the phylum."
    )

    pdf.section_heading("Limitations", level=3)
    pdf.paragraph(
        "This study provides genomic evidence for DIET in Hinthialibacterota; experimental "
        "validation of electron transfer function remains necessary. The correlation between "
        "hydrogenase absence and elevated cytochrome content (r=0.44, 95% CI [0.15, 0.66]) is "
        "significant but moderate. The small sample size for DIET genomes (n=2) limits "
        "statistical power for some comparisons. MAG completeness varies: with 725 contigs in "
        "one DIET genome, some genes may be missing from the assembly. The FeFe hydrogenases in "
        "GCA_029558215_1 may represent contamination rather than genuine phylum biology."
    )

    # Conceptual model figure
    fn = next_fig()
    pdf.add_figure(fig('fig6_conceptual_model.png'),
        f'Figure {fn}. Conceptual model of dual electron transfer strategies in Hinthialibacterota. '
        'Left: H2-mediated syntrophy (39/41 genomes) employs PFOR for ferredoxin reduction, with NiFe '
        'hydrogenases producing H2 for methanogen partners. Right: Cytochrome-based DIET (2/41 genomes) '
        'uses Rnf complex for energy conservation and MtrC-MtrF cytochrome conduits for direct '
        'electron transfer. Dockerin-cohesin interactions mediate physical attachment.')

    # ============================================================
    # METHODS
    # ============================================================
    print("  Methods...")
    pdf.add_page()
    pdf.section_heading("Methods", level=2)

    pdf.section_heading("Genome Dataset and Annotation", level=3)
    pdf.paragraph(
        "Forty-one Hinthialibacterota genome assemblies were retrieved from NCBI GenBank. "
        "Protein sequences (184,136 total) were annotated using PFAM (Pfam-A 36.0, hmmsearch "
        "--cut_ga, 283,678 hits), CAZy via dbCAN (39,579 hits), KEGG KofamScan, VOGdb release "
        "232 (101,249 hits), and DefenseFinder (27,276 hits). Hydrogenase classification used "
        "HydDB HMMs with subsequent PFAM domain validation to distinguish true hydrogenases "
        "from Complex I respiratory subunits. Subgroup assignment used DIAMOND BLAST against "
        "HydDB reference sequences. Giant proteins with no standard PFAM hits were re-analyzed "
        "with relaxed e-value thresholds (1e-5) to recover domain annotations."
    )

    pdf.section_heading("Statistical Analysis", level=3)
    pdf.paragraph(
        "Group comparisons used Mann-Whitney U tests (genome size, defense burden, transporter "
        "content) and Fisher's exact tests (CRISPR presence). Correlation analysis employed "
        "Pearson and Spearman coefficients with bootstrap resampling (10,000 iterations) for "
        "95% confidence intervals. One-way ANOVA compared features across three ecotype groups. "
        "Hierarchical clustering used Ward's linkage on z-score transformed features normalized "
        "per 1000 proteins."
    )

    pdf.section_heading("Structure Prediction and Homology", level=3)
    pdf.paragraph(
        "Protein structures were predicted using ESM3 via the Forge API (esm3-medium-2024-08 "
        "model). Structural homology searches used Foldseek against AlphaFold Database 50% "
        "(afdb50) and PDB 100% (pdb100). Heme-binding sites were counted by CxxCH motif scanning. "
        "Twelve proteins were predicted and searched, including DIET conduit components, orphan-"
        "exclusive DUF proteins, and novel defense system proteins."
    )

    # ============================================================
    # STRUCTURE PREDICTION RESULTS
    # ============================================================
    print("  Structure prediction results...")
    pdf.add_page()
    pdf.section_heading("Structure Prediction Results", level=2)

    pdf.paragraph(
        "ESM3 structure predictions were generated for 12 proteins of interest using the "
        "Forge API (esm3-medium-2024-08 model). Predicted structures were searched against "
        "Foldseek databases (afdb50, pdb100). Key findings are summarized below."
    )

    # Summary table
    struct_table = [
        ['Name', 'Length', 'pLDDT', 'pTM', 'Top Foldseek Hit', 'E-value'],
        ['DS41_defense', '498', '0.91', '0.89', 'KAP NTPase domain', '8.0e-66'],
        ['Lamassu_Cap4', '229', '0.95', '0.93', 'ABC transporter ATP-bd', '3.0e-28'],
        ['DUF4405_conduit', '317', '0.80', '0.63', 'DUF4405 (Omnitrophota)', '1.8e-39'],
        ['Cohesin_receptor', '321', '0.79', '0.47', 'Cohesin (Omnitrophota)', '4.4e-29'],
        ['DUF3332_orphan', '197', '0.79', '0.53', 'DUF3332 family', '7.7e-29'],
        ['DUF4384_standalone', '247', '0.76', '0.71', 'DUF4384 + LysM remote', '2.9e-36'],
        ['DUF4384_Caspase', '485', '0.73', '0.59', 'Peptidase C14 caspase', '4.5e-75'],
        ['Upstream_43heme', '240', '0.65', '0.66', 'Porin fold', '7.5e-16'],
        ['Between_cohesins', '417', '0.61', '0.38', 'Cohesin + Dockerin(!)' , '6.6e-35'],
        ['Adj_43heme', '293', '0.59', '0.48', 'Omnitrophota only', '1.4e-32'],
        ['CsgG_upstream', '420', '0.55', '0.33', 'TPR repeat scaffold', '4.2e-28'],
        ['Regulatory', '181', '0.37', '0.14', 'No hits (disordered)', '-'],
    ]
    avail = pdf.w - pdf.l_margin - pdf.r_margin - 2
    widths = [avail*0.22, avail*0.08, avail*0.08, avail*0.07, avail*0.42, avail*0.13]
    pdf.render_table(struct_table, col_widths=widths)

    pdf.section_heading("Notable Structural Findings", level=3)
    highlights = [
        "DS-41 defense protein (pLDDT 0.91, pTM 0.89): Identified as a KAP NTPase via Foldseek "
        "(E=8e-66, 100% identity). This previously unannotated protein is definitively a known "
        "defense-associated NTPase, confirming DS-41 as a bona fide anti-phage system.",

        "Gene 61 between cohesins (pLDDT 0.61): Foldseek reveals this protein is itself a cohesin "
        "domain protein, with a critical hit to a Dockerin domain in Methanosarcinales archaea "
        "(E=2.1e-11). This directly supports the trans-species docking hypothesis with methanogen partners.",

        "Gene 50 upstream of 43-heme (pLDDT 0.65, pTM 0.66): Structural homology to porins "
        "(E=7.5e-16, 55% identity) suggests an outer membrane beta-barrel pore through which "
        "the 43-heme cytochrome conduit may thread.",

        "DUF4384+Caspase (pLDDT 0.73): Confirmed peptidase C14 caspase fold. Foldseek hits to "
        "Candidatus Moduliflexus flocculans and Desulfobacterales -- both syntrophic lineages -- "
        "suggest this orphan-exclusive system is a programmed cell death effector.",

        "Lamassu Cap4 (pLDDT 0.95, pTM 0.93): Highest-confidence prediction. Structural match to "
        "ABC transporter ATP-binding domains reflects the shared NTPase fold of Cap4 nucleases.",

        "Regulatory adapter (pLDDT 0.37): Intrinsically disordered with no Foldseek hits. "
        "Likely functions only upon binding a partner protein in the conduit complex.",
    ]
    for h in highlights:
        pdf.bullet_item(h)

    # ============================================================
    # SUPPLEMENTARY: FEATURE HEATMAP
    # ============================================================
    print("  Feature heatmap...")
    pdf.add_page()
    pdf.section_heading("Supplementary: Genome Feature Overview", level=2)
    fn = next_fig()
    pdf.add_figure(fig('fig4_feature_heatmap.png'),
        f'Figure {fn}. Functional feature density across all 41 Hinthialibacterota genomes. '
        'Heatmap shows features per 1000 proteins, with genomes sorted by ecotype (color strip: '
        'red = DIET, orange = orphan dockerin, blue = cohesin+). '
        'DIET genomes show distinctive profiles with elevated electron transfer and reduced hydrogenase.',
        max_width=155)

    # ============================================================
    # SUPPLEMENTARY FIGURES
    # ============================================================
    print("  Supplementary figures...")
    pdf.add_page()
    pdf.section_heading("Supplementary Figures", level=2)
    pdf.paragraph(
        "Selected gene neighborhood diagrams showing key genomic loci discussed in the text. "
        "Arrows indicate gene direction and are colored by functional category. "
        "Red arrows highlight the query protein."
    )

    supp_figs = [
        ('diet_cytochrome_conduit_GCA_029261095_1.png',
         'Cytochrome conduit locus in DIET genome GCA_029261095_1. '
         'The same conserved arrangement is found despite 725 contigs, '
         'supporting DIET as genuine biology.'),
        ('mtrc_diet_locus.png',
         'MtrC electron conduit locus showing POR through periplasmic cytochromes to outer membrane.'),
        ('mbh_hydrogenase_locus.png',
         'Energy-conserving Mbh hydrogenase operon in GCA_016934335_1. Complete membrane-bound '
         'complex with catalytic and membrane subunits.'),
        ('GCA_029558215_1_FeFe_hydrogenase.png',
         'Electron-bifurcating FeFe hydrogenase complex with NAD-binding module '
         'and 2Fe-2S thioredoxin electron carrier.'),
        ('GCA_029558215_1_NiFeSe_hydrogenase.png',
         'Selenium-containing NiFeSe hydrogenase operon with maturation proteins.'),
        ('GCA_029261095_1_cytochrome_conduit.png',
         'Multi-heme cytochrome array in the DIET genome. Giant beta-helix protein '
         'and multiple multi-heme cytochromes.'),
        ('GCA_003598175_1_tad_operon.png',
         'Complete Tad (Tight adherence) pilus operon for irreversible cell attachment.'),
        ('defense_druantia_superisland.png',
         'Druantia defense superisland with 4 consecutive giant defense proteins totaling >5.5 kDa.'),
        ('giant_nrps_locus_OY759334.png',
         'Giant NRPS-like biosynthetic cluster with VOGdb homology (likely chromosomal).'),
        ('GCA_029261095_1_giant_unknown.png',
         '3,948 aa unannotated protein in DIET genome adjacent to Type II Secretion System.'),
        ('GCA_029261095_1_toxin.png',
         'TcdB-like toxin-adhesin chimera (2,315 aa) in DIET genome with ADP-ribosyltransferase domain.'),
        ('GCA_029558215_1_mega_signaling.png',
         '2,549 aa signal integrator with 10+ GAF sensors, PAS domains, and two-component output.'),
    ]

    sfig_n = 0
    for fig_file, cap in supp_figs:
        fpath = FIGURES_DIR / fig_file
        if fpath.exists():
            if pdf.get_y() > pdf.h - 110:
                pdf.add_page()
            sfig_n += 1
            pdf.add_figure(str(fpath), f'Supplementary Figure S{sfig_n}. {cap}')

    # ============================================================
    # SAVE
    # ============================================================
    total_pages = pdf.page_no()
    print(f"\nSaving to {OUTPUT_PDF}...")
    pdf.output(str(OUTPUT_PDF))

    print("\n" + "=" * 60)
    print("COMPLETE")
    print("=" * 60)
    print(f"  Output: {OUTPUT_PDF}")
    print(f"  Pages: {total_pages}")
    print(f"  Main figures: {fc[0]}")
    print(f"  Supplementary figures: {sfig_n}")
    return OUTPUT_PDF


if __name__ == "__main__":
    generate_report()
